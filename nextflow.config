// Nextflow configuration for QTL2 Pipeline
// Single container approach for r/qtl2 and data manipulation

// Pipeline metadata
manifest {
    name            = 'QTL2_NF'
    author          = 'Dpbudke'
    homePage        = 'https://github.com/Dpbudke/QTL2_NF'
    description     = 'Nextflow pipeline for multiparental mouse QTL analysis using r/qtl2'
    mainScript      = 'main.nf'
    nextflowVersion = '>=23.04.0'
    version         = '1.0.0'
}

// Default parameters
params {
    // Input files (generated from your pre-pipeline RMD)
    phenotype_file     = 'Data/formatted_phenotypes_for_nextflow.csv'
    finalreport_file   = 'Data/FinalReport.txt'
    genotype_file      = null  // Will be added in future modules
    genetic_map        = null  // Will be added in future modules
    
    // Study configuration
    study_prefix       = 'MyStudy'
    auto_prefix_samples = false  // Set to true if you want automatic sample ID prefixing
    test_mode          = false   // Set to true to process chromosome 19 only (for development)
    
    // Output directory
    outdir             = 'results'
    
    // Process-specific parameters
    // Module 1: Phenotype Processing
    pheno_na_strings   = 'na,NA,N/A,'
    
    // Help message
    help               = false
}

// Global work directory
workDir = '/project/do2_projects/DO_Choline/QTL2_NF/nextflow_work'

// Process configuration
process {
    // Default settings for all processes
    shell = ['/bin/bash', '-euo', 'pipefail']
    
    // Single container for all processes
    container = 'dpbudke/qtl2-pipeline:latest'
    
    // SLURM executor for HPC
    executor = 'slurm'
    clusterOptions = '--account=do2_projects --mail-type=END,FAIL --mail-user=dpbudke@ucdavis.edu'
    
    // Resource defaults
    cpus   = 2
    memory = '4 GB'
    time   = '2h'
    
    // Error handling
    errorStrategy = 'retry'
    maxRetries    = 2
    
    // Process-specific overrides
    withName: PHENOTYPE_PROCESS {
        cpus   = 1
        memory = '2 GB'
        time   = '1h'
        clusterOptions = '--account=do2_projects --mail-type=END,FAIL --mail-user=dpbudke@ucdavis.edu'
    }
    
    // Module 2: Genotype processing (high memory for large 1.9GB file)
    withName: GENOTYPE_PROCESS {
        cpus   = 4
        memory = '128 GB'
        time   = '8h'
        clusterOptions = '--account=do2_projects --mail-type=END,FAIL --mail-user=dpbudke@ucdavis.edu'
    }
}

// Execution profiles
profiles {
    
    // HPC/Ceres execution (default)
    standard {
        process.executor = 'slurm'
        apptainer.enabled = true
        apptainer.autoMounts = true
        apptainer.cacheDir = '/project/do2_projects/DO_Choline/QTL2_NF/singularity_cache'
    }
    
    // Local execution 
    local {
        process.executor = 'local'
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
    
    // Docker profile (for local development)
    docker {
        process.executor = 'local'
        docker.enabled = true
        docker.runOptions = '-u $(id -g):$(id -g)'
    }
    
    // Development/testing profile
    test {
        params.phenotype_file = 'test_data/small_phenotypes.csv'
        params.study_prefix = 'Test'
        params.outdir = 'test_results'
        params.test_mode = true  // Process only chr 19
        
        process {
            cpus = 1
            memory = '2 GB'
            time = '1h'
        }
    }
}

// Reporting and monitoring
timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_timeline.html"
}

report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_report.html"
}

trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_trace.txt"
}

dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/pipeline_dag.svg"
}

// Cleanup options
cleanup = false  // Set to true in production

// Apptainer settings (primary for HPC)
apptainer {
    enabled = false  // Will be enabled by profile
    autoMounts = true
    cacheDir = '/project/do2_projects/DO_Choline/QTL2_NF/singularity_cache'
}

// Singularity settings (disabled, keeping for compatibility)
singularity {
    enabled = false
    autoMounts = true
    cacheDir = '/project/do2_projects/DO_Choline/QTL2_NF/singularity_cache'
}

// Docker settings (for local development)
docker {
    enabled = false  // Will be enabled by profile
    temp = 'auto'
}

// Resource monitoring
monitor {
    enabled = false  // Enable for detailed resource monitoring
}